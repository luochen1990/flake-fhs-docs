---
title: NixOS 模块 (Modules)
description: 学习如何组织可复用的 NixOS 模块，包括自动发现机制、Guarded Modules 和 Unguarded Modules 的使用
---

import { FileTree, Steps, Aside, Badge } from '@astrojs/starlight/components';

`modules/` 目录用于组织可复用的 NixOS 模块。系统将根据目录特征自动分类加载，无需手动维护 `module-list.nix`。

## 目录结构与加载逻辑

框架将目录分为两类：**Guarded** (含 `options.nix`) 和 **Unguarded** (普通目录)。

<FileTree>

- modules/
  - base/  <Badge text="Unguarded: 纯组织容器" variant="default" size="small" />
    - shell.nix  <Badge text="自动导入" variant="default" size="small" />
    - users.nix  <Badge text="自动导入" variant="default" size="small" />
  - services/
    - web-server/  <Badge text="Guarded: 包含 options.nix" variant="default" size="small" />
      - options.nix  <Badge text="总是导入" variant="default" size="small" />
      - config.nix   <Badge text="仅当 enable = true 时生效" variant="default" size="small" />
      - sub-helper/  <Badge text="递归扫描并自动导入" variant="default" size="small" />
  - personal/
    - config.nix   <Badge text="自动导入" variant="default" size="small" />

</FileTree>

### 加载规则

<Steps>

1.  **Unguarded 目录**:
    *   如果包含 `default.nix`，则仅导入 `default.nix`（停止递归）。
    *   否则，导入目录下所有 `.nix` 文件，并递归扫描子目录。

2.  **Guarded 目录** (`options.nix` 存在):
    *   **options.nix**: 总是被导入，用于定义选项接口。
    *   **其他文件** (如 `config.nix`, `default.nix` 等): 只有当该模块被**启用**时才会生效。
        *   这通过内部生成的 `config = lib.mkIf cfg.enable { ... }` 包装器实现。

</Steps>

## 使用方法

### 定义一个 Guarded 模块

以 `modules/services/web-server` 为例：

**1. `options.nix`: 定义接口**

<Aside type="caution" title="严格模式 (Strict Mode)">
默认情况下，`optionsMode` 为 `strict`。你需要显式定义完整的选项路径（例如 `options.services.web-server`），框架会检查其是否匹配目录结构。
</Aside>

<Aside type="tip" title="自动 Enable">
框架会自动在模块路径下生成 `enable` 选项（如果未手动定义）。
</Aside>

```nix
{ lib, ... }:
{
  options.services.web-server = {
    # 需完整写出 options.services.web-server
    port = lib.mkOption {
      type = lib.types.port;
      default = 8080;
    };
  };
}
```

**2. `config.nix`: 实现逻辑**

默认会被包裹在 `mkIf cfg.enable { ... }` 中。

```nix
{ config, pkgs, ... }:
let 
  cfg = config.services.web-server;
in
{
  # 无需手动写 config = lib.mkIf cfg.enable ...
  
  systemd.services.web-server = {
    description = "Simple Python Web Server";
    wantedBy = [ "multi-user.target" ];
    serviceConfig = {
      ExecStart = "${pkgs.python3}/bin/python -m http.server ${toString cfg.port}";
      Restart = "always";
    };
  };
}
```

### 使用模块

在 `hosts/my-machine/configuration.nix` 中：

```nix
{
  # modules/ 下的模块已被自动发现并导入
  services.web-server.enable = true;
  services.web-server.port = 9000;
}
```
